<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vue 3 + Firebase</title>

  <!-- Vue 3 CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
</head>
<body>
  <div id="app" class="container p-4"></div>

  <script>
    const { createApp, ref, onMounted } = Vue;

    // üî• Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAsEANU9p5dXhUIgITl-k5W3Wzh4K-7wfM",
      authDomain: "finalmobileweb.firebaseapp.com",
      projectId: "finalmobileweb",
      storageBucket: "finalmobileweb.firebasestorage.app",
      messagingSenderId: "763318502667",
      appId: "1:763318502667:web:8aa0a7f919c3df79be0e0e",
      measurementId: "G-LSNZG1BMNT"
    };

    // üî• Firebase Initialization
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const firestore = firebase.firestore();

    createApp({
      setup() {
        const user = ref(null);
        const classrooms = ref([]);
        const showForm = ref(false);

        const classCode = ref("");
        const className = ref("");
        const classRoom = ref("");
        const classPhoto = ref("");

        /** üî• ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ */
        async function fetchClassrooms() {
          if (!user.value) return;
          const querySnapshot = await firestore.collection("users").doc(user.value.uid).collection("classroom").get();
          classrooms.value = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        /** üî• ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô */
        async function createClassroom() {
          if (!user.value) {
            console.error("üö® ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô createClassroom() ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô");
            return;
          }

          console.log("‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...");
          console.log("üìå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ:", classCode.value, className.value, classRoom.value, classPhoto.value);

          const classRef = firestore.collection("users").doc(user.value.uid).collection("classroom").doc();
          await classRef.set({
            owner: user.value.uid,
            info: {
              code: classCode.value,
              name: className.value,
              room: classRoom.value,
              photo: classPhoto.value
            }
          });

          console.log(`‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${classRef.id} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
          showForm.value = false;
          fetchClassrooms();
        }

        /** üî• ‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô */
        async function deleteClassroom(classroomId) {
          if (!user.value) return;
          const confirmDelete = confirm("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ?");
          if (!confirmDelete) return;

          await firestore.collection("users").doc(user.value.uid).collection("classroom").doc(classroomId).delete();
          console.log(`üóëÔ∏è ‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${classroomId} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
          fetchClassrooms();
        }

        /** üî• Login ‡∏î‡πâ‡∏ß‡∏¢ Google */
        async function signInWithGoogle() {
          const provider = new firebase.auth.GoogleAuthProvider();
          try {
            const result = await auth.signInWithPopup(provider);
            user.value = result.user;
            await fetchClassrooms();
          } catch (error) {
            console.error("üö® Google Sign-in Error:", error);
          }
        }

        /** üî• Logout */
        async function signOut() {
          try {
            await auth.signOut();
            user.value = null;
            classrooms.value = [];
          } catch (error) {
            console.error("üö® Sign-out Error:", error);
          }
        }

        onMounted(() => {
          auth.onAuthStateChanged(async (loggedUser) => {
            if (loggedUser) {
              user.value = loggedUser;
              await fetchClassrooms();
            } else {
              user.value = null;
            }
          });
        });

        return {
          user,
          classrooms,
          showForm,
          classCode,
          className,
          classRoom,
          classPhoto,
          signInWithGoogle,
          signOut,
          createClassroom,
          deleteClassroom
        };
      },
      template: `
        <div class="card">
          <div class="card-header text-center">
            <b>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</b>
          </div>

          <div class="card-body text-center">
            <div v-if="user">
              <img :src="user.photoURL" class="rounded-circle" width="100" height="100" />
              <h4 class="mt-2">{{ user.displayName }}</h4>
              <p>{{ user.email }}</p>
              <button class="btn btn-danger mb-3" @click="signOut">Sign Out</button>

              <h5 class="mt-4">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h5>
              <ul class="list-group">
                <li v-for="classroom in classrooms" :key="classroom.id" class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <img :src="classroom.info.photo" class="rounded" width="50" height="50" v-if="classroom.info.photo"/>
                    {{ classroom.info.name }} ({{ classroom.info.code }})
                  </div>
                  <button class="btn btn-danger btn-sm" @click="deleteClassroom(classroom.id)">üóëÔ∏è ‡∏•‡∏ö</button>
                </li>
              </ul>

              <button class="btn btn-primary mt-3" @click="showForm = !showForm">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>

              <div v-if="showForm" class="mt-3">
                <input type="text" class="form-control mb-2" v-model="classCode" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤" />
                <input type="text" class="form-control mb-2" v-model="className" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤" />
                <input type="text" class="form-control mb-2" v-model="classRoom" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" />
                <input type="text" class="form-control mb-2" v-model="classPhoto" placeholder="URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" />
                <button class="btn btn-success" @click="createClassroom">‡∏™‡∏£‡πâ‡∏≤‡∏á</button>
              </div>
            </div>
            <button v-else class="btn btn-primary" @click="signInWithGoogle">Sign in with Google</button>
          </div>
        </div>
      `
    }).mount("#app");
  </script>
</body>
</html>
