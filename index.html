<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vue 3 + Firebase</title>

    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
  </head>
  <body>
    <div id="app" class="container p-4"></div>

    <script>
      const { createApp, ref, onMounted } = Vue;

      // üî• Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyAsEANU9p5dXhUIgITl-k5W3Wzh4K-7wfM",
        authDomain: "finalmobileweb.firebaseapp.com",
        projectId: "finalmobileweb",
        storageBucket: "finalmobileweb.firebasestorage.app",
        messagingSenderId: "763318502667",
        appId: "1:763318502667:web:8aa0a7f919c3df79be0e0e",
        measurementId: "G-LSNZG1BMNT"
      };

      // üî• Firebase Initialization
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const firestore = firebase.firestore();

      createApp({
        setup() {
          const user = ref(null);
          const className = ref("");
          const classCode = ref("");
          const classRoom = ref("");
          const classPhoto = ref("");

          /** üî• ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡∏á Firestore */
          async function saveUserToFirestore(user) {
            if (!user) return;
            const userRef = firestore.collection("users").doc(user.uid);
            const userSnapshot = await userRef.get();

            if (!userSnapshot.exists) {
              await userRef.set({
                name: user.displayName,
                email: user.email,
                photo: user.photoURL
              });

              console.log("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á Firestore");
            }
          }

          /** üî• ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô */
          async function createClassroom() {
            if (!user.value) return;

            const classRef = firestore.collection("classroom").doc();
            await classRef.set({
              owner: user.value.uid,
              info: {
                code: classCode.value,
                name: className.value,
                photo: classPhoto.value,
                room: classRoom.value
              }
            });

            console.log(`‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${className.value} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡πÉ‡∏ô /users/{uid}/classroom/{cid}
            const userClassRef = firestore.collection("users").doc(user.value.uid).collection("classroom").doc(classRef.id);
            await userClassRef.set({
              status: 1 // 1 = ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå
            });

            console.log(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${className.value} ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${user.value.uid}`);
          }

          /** üî• Login ‡∏î‡πâ‡∏ß‡∏¢ Google */
          async function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
              const result = await auth.signInWithPopup(provider);
              user.value = result.user;
              await saveUserToFirestore(user.value);
            } catch (error) {
              console.error("üö® Google Sign-in Error:", error);
            }
          }

          /** üî• Logout */
          async function signOut() {
            try {
              await auth.signOut();
              user.value = null;
            } catch (error) {
              console.error("üö® Sign-out Error:", error);
            }
          }

          onMounted(() => {
            auth.onAuthStateChanged(async (loggedUser) => {
              if (loggedUser) {
                user.value = loggedUser;
                await saveUserToFirestore(user.value);
              } else {
                user.value = null;
              }
            });
          });

          return {
            user,
            className,
            classCode,
            classRoom,
            classPhoto,
            signInWithGoogle,
            signOut,
            createClassroom
          };
        },
        template: `
          <div class="card">
            <div class="card-header">
              <div class="alert alert-info text-center">
                <b>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</b>
              </div>
            </div>

            <div class="card-body text-center">
              <div v-if="user">
                <img :src="user.photoURL" class="rounded-circle" width="100" height="100" />
                <h4 class="mt-2">{{ user.displayName }}</h4>
                <p>{{ user.email }}</p>
                <button class="btn btn-danger" @click="signOut">Sign Out</button>

                <h5 class="mt-4">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h5>
                <form>
                  <div class="mb-2">
                    <input type="text" class="form-control" v-model="className" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤" />
                  </div>
                  <div class="mb-2">
                    <input type="text" class="form-control" v-model="classCode" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤" />
                  </div>
                  <div class="mb-2">
                    <input type="text" class="form-control" v-model="classRoom" placeholder="‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" />
                  </div>
                  <div class="mb-2">
                    <input type="text" class="form-control" v-model="classPhoto" placeholder="URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" />
                  </div>
                  <button type="button" class="btn btn-success mt-2" @click="createClassroom">
                    ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                  </button>
                </form>
              </div>
              <button v-else class="btn btn-primary" @click="signInWithGoogle">
                Sign in with Google
              </button>
            </div>

            <div class="card-footer text-center">
              College of Computing, Khon Kaen University
            </div>
          </div>
        `
      }).mount("#app");
    </script>
  </body>
</html>
