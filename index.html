<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- QRCode.js -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    #qrcode {
      padding: 20px;
      background: white;
      border-radius: 10px;
      display: inline-block;
    }

    .card {
      cursor: pointer;
      transition: transform 0.2s;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .profile-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .create-form {
      max-width: 600px;
      margin: 0 auto;
    }

    .logo {
      width: 1200px;
      height: auto;
      margin-top: 50px;
    }

    @font-face {
      font-family: myProjectFont;
      src: url(font/ibmplexsansthairegular.ttf);
    }

    body{
      font-family: myProjectFont;
    }

  </style>
</head>

<body>
  <div id="app" class="container py-4">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">
          <i class="fas fa-graduation-cap"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        </a>
        <div v-if="user" class="d-flex align-items-center">
          <img :src="userPhoto" class="rounded-circle me-2" width="32" height="32" v-if="userPhoto">
          <span class="me-3">{{ userName }}</span>
          <button class="btn btn-outline-danger" @click="signOut">
            <i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
          </button>
        </div>
      </div>
    </nav>

    <!-- Login Screen -->
    <div v-if="!user" class="text-center">
      <h2 class="mb-4">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h2>
      <button class="btn btn-primary btn-lg" @click="signInWithGoogle">
        <i class="fab fa-google me-2"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google
      </button>
      <div><img class="logo" src="./img/logocom.png" alt="logo"></div>
    </div>

    <!-- Main Content -->
    <div v-else>
      <div v-if="!currentClassroomId">
        <!-- Profile Section -->
        <div v-if="showProfile" class="profile-section">
          <h4 class="mb-3">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h4>
          <div class="row">
            <div class="col-md-4 text-center">
              <img :src="userPhoto" class="rounded-circle mb-3" width="150" height="150" v-if="userPhoto">
            </div>
            <div class="col-md-8">
              <div class="mb-3">
                <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                <input type="text" v-model="userName" class="form-control">
              </div>
              <div class="mb-3">
                <label class="form-label">URL ‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</label>
                <input type="text" v-model="userPhoto" class="form-control">
              </div>
              <button class="btn btn-success" @click="updateProfile">
                <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
              </button>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="text-center mb-4">
          <button class="btn btn-info me-2" @click="showProfile = !showProfile">
            <i class="fas fa-user"></i> {{ showProfile ? '‡∏ã‡πà‡∏≠‡∏ô' : '‡πÅ‡∏™‡∏î‡∏á' }}‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
          </button>
          <button class="btn btn-primary" @click="showCreateForm = !showCreateForm">
            <i class="fas fa-plus"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
          </button>
        </div>

        <!-- Create Classroom Form -->
        <div v-if="showCreateForm" class="create-form card p-4 mb-4">
          <h4 class="text-center mb-3">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h4>
          <div class="mb-3">
            <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤</label>
            <input type="text" class="form-control" v-model="classCode">
          </div>
          <div class="mb-3">
            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤</label>
            <input type="text" class="form-control" v-model="className">
          </div>
          <div class="mb-3">
            <label class="form-label">URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label>
            <input type="text" class="form-control" v-model="classPhoto">
          </div>
          <button class="btn btn-success w-100" @click="createClassroom">
            <i class="fas fa-plus-circle"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
          </button>
        </div>

        <!-- Classrooms Grid -->
        <div class="row">
          <div v-for="classroom in classrooms" :key="classroom.id" class="col-md-4 mb-4">
            <div class="card">
              <img :src="classroom.info.photo || 'https://via.placeholder.com/400'" class="card-img-top"
                alt="classroom image" style="height: 200px; object-fit: cover;">
              <div class="card-body">
                <h1 class="card-title"><b>{{ classroom.info.name }}</b></h1>
                <p class="card-text">‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤: {{ classroom.info.code }}</p>
                <div class="btn-group w-100">
                  <button class="btn btn-primary" @click="viewClassroom(classroom.id)">
                    <i class="fas fa-eye"></i> ‡∏î‡∏π
                  </button>
                  <button class="btn btn-warning" @click="editClassroom(classroom)">
                    <i class="fas fa-edit"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                  </button>
                  <button class="btn btn-danger" @click="confirmDelete(classroom)">
                    <i class="fas fa-trash"></i> ‡∏•‡∏ö
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

     <!-- Classroom Detail -->
<div v-if="currentClassroomId">
  <button class="btn btn-secondary mb-3" @click="backToHome">
    <i class="fas fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
  </button>

  <!-- Classroom information section -->
  <div class="card mb-4">
    <div class="card-body">

      <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏ß‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û -->
      <table class="table">
        <tr>
          <td style="width: 100px; vertical-align: middle;">
            <!-- ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô -->
            <img :src="currentClassroom.info.photo" class="img-fluid rounded" style="max-width: 200px; object-fit: cover;" v-if="currentClassroom.info.photo">
          </td>
          <td>
            <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô -->
            <h1><b>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤: </b> {{ currentClassroom.info.name }}</h1>
            <br>
            <h1><b>‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤: </b> {{ currentClassroom.info.code }}</h1>
            <br>

            <button class="btn btn-primary" @click="openCreateQuestionModal">
              <i class="fa-solid fa-plus"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
            </button>
            
            <!-- ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° -->
<!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° -->
<div class="mt-3">
  <h4>üìå ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</h4>
  <table class="table">
    <thead>
      <tr>
        <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
        <th>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</th>
        <th class="text-end">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th> <!-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô class ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ text-end ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏ß‡∏≤ -->
      </tr>
    </thead>
    <tbody>
      <tr v-for="(question, index) in questions" :key="question.id">
        <td>{{ index + 1 }}</td>
        <td>{{ question.question_text }}</td>
        <td class="text-end"> <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° class text-end ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏ä‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤ -->
          <button class="btn btn-success btn-sm" @click="viewAnswers(question.id)">
            <i class="fas fa-eye"></i> ‡∏î‡∏π‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
          </button>
          <button class="btn btn-danger btn-sm ms-2" @click="deleteQuestion(question.id)">
            <i class="fas fa-trash"></i> ‡∏•‡∏ö
          </button>
        </td>
      </tr>
    </tbody>
  </table>
</div>
            

          </td>
        </tr>
      </table>
    </div>
  </div>

<!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
<div class="btn-group w-100 d-flex justify-content-between">
  <div>
    <button class="btn btn-success" @click="openCheckin">
      <i class="fas fa-check-circle"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
    </button>
    <button class="btn btn-warning" @click="closeCheckin" style="margin-left: 8px;">
      <i class="fas fa-times-circle"></i> ‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
    </button>
    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ -->
    <button class="btn btn-info ms-2" @click="showCheckinDetailsModal">
      <i class="fas fa-info-circle"></i> ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
    </button>
  </div>

  <div>
    <button class="btn btn-info ms-auto" @click="showStudentList">
      <i class="fas fa-users"></i> ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
    </button>
    <button class="btn btn-primary ms-2" @click="showQRCode(currentClassroomId)">
      <i class="fas fa-qrcode"></i> ‡πÅ‡∏™‡∏î‡∏á QR Code
    </button>
  </div>
</div>


<div v-if="showStudents" class="mt-3">
  <h4>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
  <table class="table">
    <thead>
      <tr>
        <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
        <th>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
      </tr>
    </thead>
    <tbody>
      <tr v-for="(student, index) in students" :key="student.id">
        <td>{{ index + 1 }}</td>  <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö -->
        <td>{{ student.std_id }}</td>  <!-- ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô -->
        <td>{{ student.std_name }}</td> <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô -->
        <td>
          <!-- ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á status ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤" ‡∏ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô 2 -->
          <span v-if="student.status === 2">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</span>
          <span v-else>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</span>
        </td> <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
      </tr>
    </tbody>
  </table>
</div>

        <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -->
        <div v-if="showScores" class="mt-3">
          <h4>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
          <table class="table">
            <thead>
              <tr>
                <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                <th>‡∏£‡∏´‡∏±‡∏™</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                <th>‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</th>
                <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="student in scores" :key="student.id">
                <td>{{ student.index }}</td>
                <td>{{ student.id }}</td>
                <td>{{ student.name }}</td>
                <td><input type="text" v-model="student.remark" class="form-control"></td>
                <td>{{ student.timestamp }}</td>
                <td><input type="number" v-model="student.score" class="form-control"></td>
                <td><input type="text" v-model="student.statusText" class="form-control"></td>
              </tr>
            </tbody>
          </table>

          <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -->
          <button class="btn btn-success" @click="saveScores">
            <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          </button>
        </div>
      </div>

      <div v-if="showStudents_checkin" class="mt-3">
        <h4>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</h4>
        <table class="table">
          <thead>
            <tr>
              <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
              <th>‡∏£‡∏´‡∏±‡∏™</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠</th>
              <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
              <th>‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</th>
              <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="student in students" :key="student.id">
              <td>{{ student.index }}</td>
              <td>{{ student.id }}</td>
              <td>{{ student.name }}</td>
              <td>{{ student.status }}</td>
              <td>{{ student.timestamp }}</td>
              <td>
                <button class="btn btn-danger btn-sm" @click="removeStudent(student.id)">
                  <i class="fas fa-trash"></i> ‡∏•‡∏ö
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>


      <!-- Edit Classroom Modal -->
      <div class="modal fade" id="editClassroomModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤</label>
                <input type="text" class="form-control" v-model="editingClassroom.code">
              </div>
              <div class="mb-3">
                <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤</label>
                <input type="text" class="form-control" v-model="editingClassroom.name">
              </div>
              <div class="mb-3">
                <label class="form-label">URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label>
                <input type="text" class="form-control" v-model="editingClassroom.photo">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
              <button type="button" class="btn btn-primary" @click="saveEdit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Delete Confirmation Modal -->
      <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <p>‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô "{{ deletingClassroom?.info?.name }}"?</p>
              <p class="text-danger">‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ </p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
              <button type="button" class="btn btn-danger" @click="deleteClassroom">‡∏•‡∏ö</button>
            </div>
          </div>
        </div>
      </div>

      <!-- QR Code Modal -->
      <div class="modal fade" id="qrCodeModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
              <div id="qrcode"></div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-success" @click="downloadQRCode">
                <i class="fas fa-download"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î QR Code
              </button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° -->
<div class="modal fade" id="createQuestionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label class="form-label">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:</label>
        <input type="text" v-model="newQuestionText" class="form-control">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button type="button" class="btn btn-primary" @click="saveQuestion">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="viewAnswersModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <h5>üìå ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: {{ selectedQuestionText }}</h5>
        <table class="table mt-3">
          <thead>
            <tr>
              <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö</th>
              <th>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</th>
              <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(answer, index) in answers" :key="answer.id">
              <td>{{ index + 1 }}</td>
              <td>{{ answer.std_name }}</td>
              <td>{{ answer.text }}</td>
              <td>{{ answer.time }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
</div>

<!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ Modal -->
<div class="modal fade" id="checkinDetailsModal" tabindex="-1" aria-labelledby="checkinDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="checkinDetailsModalLabel">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div v-if="checkinSessions.length > 0">
          <table class="table">
            <thead>
              <tr>
                <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th>‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</th>
                <th class="text-end">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="(session, index) in checkinSessions" :key="session.id">
                <td>{{ index + 1 }}</td>
                <!-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏≤‡∏™‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤ status -->
                <td :class="{
                  'status-closed': session.status === 1,
                  'status-open': session.status === 0
                }">
                  <span v-if="session.status === 1" style="background-color: red; color: white; padding: 2px; border-radius: 5px;">‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß</span>
                  <span v-else style="background-color: green; color:  white; padding: 2px; border-radius: 5px; ">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</span>
                </td>
                <td>{{ session.code }}</td>  <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ -->
                <td class="text-end">
                  <button class="btn btn-primary btn-sm" @click="fetchCheckinDetails(session)">
                    <i class="fas fa-eye"></i> ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div v-else>
          <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
</div>


<!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ Modal ‡∏ï‡∏£‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô -->
<div class="modal fade" id="checkinDetailsModalView" tabindex="-1" aria-labelledby="checkinDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" style="max-width: 90%; width: 90%;"> <!-- ‡πÉ‡∏ä‡πâ modal-lg ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ -->
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="checkinDetailsModalLabel">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div v-if="students.length > 0">
          <table class="table">
            <thead>
              <tr>
                <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                <th>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                <th>‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</th>
                <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th class="text-end">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th> <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" -->
              </tr>
            </thead>
            <tbody>
              <tr v-for="(student, index) in students" :key="student.id">
                <td>{{ index + 1 }}</td>
                <td>{{ student.std_id }}</td>
                <td>{{ student.std_name }}</td>
                <td>
                  <input type="text" v-model="student.std_mark" v-if="student.isEditing" class="form-control"> <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
                  <span v-else>{{ student.std_mark }}</span> <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -->
                </td>
                <td>{{ student.date }}</td>
                <td>
                  <input type="number" v-model="student.std_score" v-if="student.isEditing" class="form-control"> <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
                  <span v-else>{{ student.std_score }}</span> <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -->
                </td>
                <td>
                  <select v-model="student.status" v-if="student.isEditing" class="form-control">
                    <option value="‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß</option>
                    <option value="‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏¢">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏¢</option>
                  </select>
                  <span v-else>{{ student.status }}</span> <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -->
                </td>
                <td class="text-end">
                  <button class="btn btn-warning btn-sm" @click="editStudent(student)">
                    <i class="fas fa-edit"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                  </button>
                </td>
                <td class="text-end">
                  <button class="btn btn-success btn-sm" @click="saveStudentChanges(student)" v-if="student.isEditing">
                    <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                  </button>
                </td>
                
              </tr>
            </tbody>
          </table>
        </div>
        <div v-else>
          <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ -->
<div class="modal fade" id="checkinModal" tabindex="-1" aria-labelledby="checkinModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="checkinModalLabel">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <label for="checkinCode" class="form-label">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠:</label>
        <input type="text" id="checkinCode" class="form-control" v-model="checkinCode" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button type="button" class="btn btn-primary" @click="submitCheckin">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ -->
<div class="modal fade" id="closeCheckinModal" tabindex="-1" aria-labelledby="closeCheckinModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="closeCheckinModalLabel">‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="checkinMessage"></p> <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
</div>


<script type="module">
  import { ref } from 'vue';
  // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ Vue
</script>


    <script >

      const { createApp, ref, onMounted , watch} = Vue;

      const firebaseConfig = {
  apiKey: "AIzaSyBK5wZT8xeSclSadPwWqD5t2Gp6uZ5OWyU",
  authDomain: "testfirebase-80be9.firebaseapp.com",
  projectId: "testfirebase-80be9",
  storageBucket: "testfirebase-80be9.firebasestorage.app",
  messagingSenderId: "507617350642",
  appId: "1:507617350642:web:f809202fd2412b681e516b",
  measurementId: "G-D0DFMN0YR9"
};

      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const firestore = firebase.firestore();
      

      createApp({
        
        setup() {
          
          const answers = ref([]);
          const selectedQuestionText = ref("");
          const questions = ref([]);
          const createQuestionModal = ref(null);
          const newQuestionText = ref("");
          const user = ref(null);
          const userName = ref("");
          const userPhoto = ref("");
          const classrooms = ref([]);
          const showCreateForm = ref(false);
          const showProfile = ref(false);
          const classCode = ref("");
          const className = ref("");
          const classPhoto = ref("");
          const currentClassroomId = ref(null);
          const currentClassroom = ref(null);
          const editingClassroom = ref({ code: '', name: '', photo: '', id: null });
          const deletingClassroom = ref(null);
          const editModal = ref(null);
          const deleteModal = ref(null);
          const showStudents_checkin = ref(false);

          ////

          const students = ref([]);
          const showStudents = ref(false);
          const checkinSessions = ref({});
          const showScores = ref(false);
          const scores = ref([]);


          async function fetchCheckinSessions() {
  if (!currentClassroomId.value || !user.value) return; // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ

  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å collection checkin/{cno}
  const checkinRef = firestore.collection("users")
    .doc(user.value.uid)  // ‡πÉ‡∏ä‡πâ UID ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    .collection("classroom")
    .doc(currentClassroomId.value)  // ‡πÉ‡∏ä‡πâ ID ‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
    .collection("checkin");  // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏ doc ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏ó‡∏∏‡∏Å‡πÜ document ‡πÉ‡∏ô collection

  const snapshot = await checkinRef.get();  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Firestore

  if (!snapshot.empty) {
    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ placeholder: true
    checkinSessions.value = snapshot.docs
      .filter(doc => doc.data().placeholder !== true)  // ‡∏Å‡∏£‡∏≠‡∏á document ‡∏ó‡∏µ‡πà‡∏°‡∏µ placeholder: true
      .map(doc => ({
        id: doc.id,
        ...doc.data()  // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô document ‡πÄ‡∏õ‡πá‡∏ô object
      }));
  } else {
    console.log("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠");
    checkinSessions.value = [];  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡πá‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô array ‡πÄ‡∏õ‡∏•‡πà‡∏≤
  }
}

function editStudent(student) {
  student.isEditing = true; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
}

function showCheckinDetailsModal() {
  const modalElement = document.getElementById("checkinDetailsModal");
  const modalInstance = new bootstrap.Modal(modalElement);
  modalInstance.show();
  fetchCheckinSessions();  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firestore ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î Modal
}

function viewCheckinDetails(session) {
  console.log(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà: ${session.cno}`);
  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö session.cno ‡∏à‡∏≤‡∏Å Firestore ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
  fetchCheckinDetails(session);
}

async function fetchCheckinDetails(session) {
  if (!currentClassroomId.value || !session.id) return;

  const studentRef = firestore.collection("users").doc(user.value.uid)
    .collection("classroom").doc(currentClassroomId.value)
    .collection("checkin").doc(session.id)  // ‡πÉ‡∏ä‡πâ session.id ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
    .collection("students");

  const snapshot = await studentRef.get();
  
  if (!snapshot.empty) {
    students.value = snapshot.docs
      .filter(doc => doc.data().placeholder !== true)  // ‡∏Å‡∏£‡∏≠‡∏á document ‡∏ó‡∏µ‡πà‡∏°‡∏µ placeholder: true ‡∏≠‡∏≠‡∏Å
      .map((doc, index) => {
        const studentData = doc.data();
        return {
          id: doc.id,
          std_id: studentData.std_id,
          std_name: studentData.std_name,
          std_mark: studentData.std_mark,
          date: (studentData.date),
          std_score: studentData.std_score,
          status: studentData.status === 0 ? "‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß" : "‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏¢"
        };
      });
  } else {
    console.log("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠");
    students.value = [];
  }

  // ‡∏õ‡∏¥‡∏î Modal "‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠" ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÉ‡∏´‡∏°‡πà
  const checkinDetailsModalElement = document.getElementById("checkinDetailsModal");
  const checkinDetailsModalInstance = bootstrap.Modal.getInstance(checkinDetailsModalElement);
  if (checkinDetailsModalInstance) {
    checkinDetailsModalInstance.hide(); // ‡∏õ‡∏¥‡∏î Modal ‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô
  }

  // ‡πÄ‡∏õ‡∏¥‡∏î Modal "‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" ‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏õ‡∏∏‡πà‡∏° ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡∏∞ ‡∏≠‡∏¢‡πà‡∏≤‡∏î‡∏π‡∏ú‡∏¥‡∏î‡∏≠‡∏±‡∏ô
  const modalElement = document.getElementById("checkinDetailsModalView");
  const modalInstance = new bootstrap.Modal(modalElement);
  modalInstance.show();
}
          

          // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å Firestore
          async function fetchScores() {
            if (!currentClassroom.value || !checkinSession.value) return;

            firestore.collection("classroom").doc(currentClassroom.value.id)
              .collection("checkin").doc(checkinSession.value.toString())
              .collection("scores")
              .onSnapshot(snapshot => {
                scores.value = snapshot.docs.map((doc, index) => ({
                  id: doc.id,
                  index: index + 1,
                  name: doc.data().name,
                  status: doc.data().status ? "‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß" : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ",
                  timestamp: doc.data().timestamp?.toDate().toLocaleString() || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
                  score: doc.data().score || 0,
                  remark: doc.data().remark || "",
                  statusText: doc.data().statusText || ""
                }));
              });

            showScores.value = true; // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
          }

          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô, ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏á‡πÉ‡∏ô Firestore
          async function saveScores() {
            if (!currentClassroom.value || !checkinSession.value) return;

            for (const student of scores.value) {
              await firestore.collection("classroom").doc(currentClassroom.value.id)
                .collection("checkin").doc(checkinSession.value.toString())
                .collection("scores").doc(student.id)
                .update({
                  score: student.score,
                  remark: student.remark,
                  statusText: student.statusText
                });
            }

            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
          }


          async function removeStudent(studentId) {
            if (!currentClassroomId.value || !checkinSession.value) return;

            await firestore.collection("classroom").doc(currentClassroomId.value)
              .collection("checkin").doc(checkinSession.value.toString())
              .collection("scores").doc(studentId).delete();

            alert("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
          }

          async function showStudentList() {
  if (!currentClassroomId.value || !user.value) return;  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ

  showStudents.value = !showStudents.value;  // ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô

  const studentRef = firestore.collection("users")  // ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô collection "users"
    .doc(user.value.uid)  // ‡πÉ‡∏ä‡πâ UID ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    .collection("classroom")  // ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô collection "classroom"
    .doc(currentClassroomId.value)  // ‡πÉ‡∏ä‡πâ ID ‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    .collection("students");  // ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô collection "students"

  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Firestore
  const snapshot = await studentRef.get();
  
  if (snapshot.empty) {
    console.log("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ");
    return;  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏î‡πÜ ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
  }

  // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô students array ‡πÇ‡∏î‡∏¢‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ placeholder: true
  students.value = snapshot.docs
    .map((doc, index) => ({
      id: doc.id,  // id ‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
      std_id: doc.data().std_id,  // ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
      std_name: doc.data().std_name,  // ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
      status: doc.data().status,  // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
      placeholder: doc.data().placeholder // placeholder
    }))
    .filter(student => !student.placeholder); // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ placeholder: true ‡∏≠‡∏≠‡∏Å

  console.log("Fetched students:", students.value);  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤
}




async function openCheckin() {
  if (!currentClassroomId.value || !user.value) return;

  const checkinRef = firestore.collection("users").doc(user.value.uid)
    .collection("classroom").doc(currentClassroomId.value)
    .collection("checkin");

  // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á `cno`
  const latestCheckinDoc = await checkinRef.orderBy("cno", "desc").limit(1).get();
  let cno = 1; // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 1
  let lastStatus = 1; // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (1 = ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß)

  if (!latestCheckinDoc.empty) {
    const lastCheckin = latestCheckinDoc.docs[0].data();
    cno = lastCheckin.cno + 1;
    lastStatus = lastCheckin.status; // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á status ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
  }

  // ‚ùå ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà
  if (lastStatus === 0) {
    showCheckinErrorModal(`‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${cno - 1} ‡∏Å‡πà‡∏≠‡∏ô`);
    return;
  }

  // ‚ùå ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
  if (lastStatus === 0) {
    alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤");
    return;
  }

  // ‚úÖ **‡∏•‡∏ö document `placeholder:true` ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Firestore**
  const placeholderDoc = await checkinRef.where("placeholder", "==", true).get();
  placeholderDoc.forEach(async (doc) => {
    await checkinRef.doc(doc.id).delete();
  });

  // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
  const modalElement = document.getElementById("checkinModal");
  const modalInstance = new bootstrap.Modal(modalElement);
  modalInstance.show();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô Modal
async function submitCheckin() {
  if (!checkinCode.value.trim()) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠");
    return;
  }

  const checkinRef = firestore.collection("users").doc(user.value.uid)
    .collection("classroom").doc(currentClassroomId.value)
    .collection("checkin");

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const checkinSnapshot = await checkinRef.where("code", "==", checkinCode.value).get();
  
  if (!checkinSnapshot.empty) {
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
    alert("‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà!");
    return;
  }

  // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á `cno`
  const latestCheckinDoc = await checkinRef.orderBy("cno", "desc").limit(1).get();
  let cno = latestCheckinDoc.empty ? 1 : latestCheckinDoc.docs[0].data().cno + 1;

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• `checkin/{cno}`
  await checkinRef.doc(cno.toString()).set({
    cno: cno,
    code: checkinCode.value,
    date: firebase.firestore.FieldValue.serverTimestamp(),
    status: 0  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ status ‡πÄ‡∏õ‡πá‡∏ô 0 (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î)
  });

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á collection `students` ‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÜ ‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô `{cno}`
  await checkinRef.doc(cno.toString()).collection("students").add({ placeholder: true });

  alert(`‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${cno} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);

  // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤ checkinCode ‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î Modal
  checkinCode.value = "";
  const modalElement = document.getElementById("checkinModal");
  const modalInstance = bootstrap.Modal.getInstance(modalElement);
  modalInstance.hide();
}




          // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
          async function closeCheckin() {
  if (!currentClassroomId.value || !user.value) return;

  const checkinRef = firestore.collection("users").doc(user.value.uid)
    .collection("classroom").doc(currentClassroomId.value)
    .collection("checkin");

  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
  const latestCheckinDoc = await checkinRef.orderBy("cno", "desc").limit(1).get();

  if (latestCheckinDoc.empty) {
    showCloseCheckinModal("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠!");
    return;
  }

  const lastCheckin = latestCheckinDoc.docs[0];
  const cno = lastCheckin.data().cno;

  // ‚ùå ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
  if (lastCheckin.data().status === 1) {
    showCloseCheckinModal(`‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${cno} ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß`);
    return;
  }

  // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï `status` ‡πÄ‡∏õ‡πá‡∏ô `1`
  await checkinRef.doc(cno.toString()).update({
    status: 1
  });

  showCloseCheckinModal(`‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${cno} ‡πÅ‡∏•‡πâ‡∏ß`);
}

function showCloseCheckinModal(message) {
  const messageElement = document.getElementById("checkinMessage");
  messageElement.textContent = message; // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
  const modalElement = document.getElementById("closeCheckinModal");
  const modalInstance = new bootstrap.Modal(modalElement);
  modalInstance.show();
}

          async function saveCheckin() {
            if (!currentClassroom.value || !checkinSession.value) return;

            const studentRef = firestore
              .collection("classroom")
              .doc(currentClassroom.value.id)
              .collection("checkin")
              .doc(checkinSession.value.toString())
              .collection("scores");

            const snapshot = await studentRef.get();

            if (snapshot.empty) {
              alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô!");
              return;
            }

            snapshot.forEach((doc) => {
              studentRef.doc(doc.id).update({
                status: 1,
              });
            });

            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");

            showStudents_checkin.value = true; // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
            console.log("üì¢ showStudents_checkin ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏õ‡πá‡∏ô:", showStudents_checkin.value);

            await nextTick();
            watchCheckinStudents();
          }



          async function fetchClassrooms() {
            if (!user.value) return;
            const querySnapshot = await firestore.collection("users").doc(user.value.uid)
              .collection("classroom").get();
            classrooms.value = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          }

          async function createClassroom() {
  if (!user.value) return;

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const querySnapshot = await firestore.collection("users").doc(user.value.uid)
    .collection("classroom")
    .where("info.code", "==", classCode.value)
    .get();

  if (!querySnapshot.empty) {
    alert("‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤‡∏≠‡∏∑‡πà‡∏ô!");
    return;
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡πÉ‡∏ô collection classroom
  const classRef = firestore.collection("users").doc(user.value.uid)
    .collection("classroom").doc();

  await classRef.set({
    owner: user.value.uid,
    info: {
      code: classCode.value,
      name: className.value,
      photo: classPhoto.value
    },
    status: 1 // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ status ‡πÄ‡∏õ‡πá‡∏ô 1 (‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå)
  });

  // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á collection "students", "checkin", ‡πÅ‡∏•‡∏∞ "questions" ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ placeholder
  await classRef.collection("students").add({ placeholder: true });
  await classRef.collection("checkin").add({ placeholder: true });
  await classRef.collection("questions").add({ placeholder: true });

  showCreateForm.value = false;

  // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°
  classCode.value = "";
  className.value = "";
  classPhoto.value = "";

  fetchClassrooms();
  alert("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
}

function openCreateQuestionModal() {
  console.log("‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°");
  newQuestionText.value = "";

  const modalElement = document.getElementById("createQuestionModal");
  if (modalElement) {
    createQuestionModal.value = new bootstrap.Modal(modalElement, { backdrop: 'static', keyboard: false });
    createQuestionModal.value.show();
  } else {
    console.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö modal createQuestionModal");
  }
}

async function saveQuestion() {
  console.log("‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô saveQuestion() ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");

  if (!currentClassroomId.value || !user.value) {
    console.error("‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô");
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô!");
    return;
  }

  if (!newQuestionText.value.trim()) {
    console.error("‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å");
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å!");
    return;
  }

  const questionRef = firestore.collection("users").doc(user.value.uid)
    .collection("classroom").doc(currentClassroomId.value)
    .collection("questions");

  console.log("üìå ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ó‡∏µ‡πà Firestore...");

  try {
    // ‚úÖ ‡∏•‡∏ö placeholder ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    const placeholderDocs = await questionRef.where("placeholder", "==", true).get();
    placeholderDocs.forEach(async (doc) => {
      await questionRef.doc(doc.id).delete();
      console.log(`üóëÔ∏è ‡∏•‡∏ö placeholder: ${doc.id}`);
    });

    // ‚úÖ ‡∏î‡∏∂‡∏á question_no ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    let qno = 1;
    const latestQuestionDoc = await questionRef.orderBy("question_no", "desc").limit(1).get();
    if (!latestQuestionDoc.empty) {
      const lastQuestion = latestQuestionDoc.docs[0].data();
      qno = lastQuestion.question_no + 1;
    }

    console.log(`‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ question_no ‡πÄ‡∏õ‡πá‡∏ô ${qno}`);

    // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà
    const newQuestionRef = questionRef.doc(qno.toString());
    await newQuestionRef.set({
      question_no: qno,
      question_text: newQuestionText.value,
      question_show: true,
    });

    console.log("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");

    // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á collection answers ‡πÄ‡∏õ‡∏•‡πà‡∏≤ ‡πÜ
    await newQuestionRef.collection("answers").add({ placeholder: true });
    console.log("‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á collection answers ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");

    alert(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${qno} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);

    // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà
    fetchQuestions();

    // ‚úÖ ‡∏õ‡∏¥‡∏î Modal ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    closeCreateQuestionModal();

    // ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤ input
    newQuestionText.value = "";

  } catch (error) {
    console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:", error);
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ!");
  }
}

async function fetchQuestions() {
  if (!currentClassroomId.value || !user.value) return;

  const questionRef = firestore.collection("users").doc(user.value.uid)
    .collection("classroom").doc(currentClassroomId.value)
    .collection("questions");

  const snapshot = await questionRef.orderBy("question_no", "asc").get();
  questions.value = snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  }));

  console.log("üì¢ ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤:", questions.value);
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
async function deleteQuestion(questionId) {
  if (!currentClassroomId.value || !user.value) return;

  if (!confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

  try {
    const questionRef = firestore.collection("users").doc(user.value.uid)
      .collection("classroom").doc(currentClassroomId.value)
      .collection("questions").doc(questionId);

    // üî• ‡∏•‡∏ö sub-collection "answers"
    const answersRef = questionRef.collection("answers");
    await deleteCollection(answersRef);

    // üî• ‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å
    await questionRef.delete();

    alert("‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
    await fetchQuestions(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà
  } catch (error) {
    console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:", error);
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ!");
  }
}

// üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö Collection ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Firestore
async function deleteCollection(collectionRef) {
  const snapshot = await collectionRef.get();
  const batch = firestore.batch();

  snapshot.docs.forEach(doc => {
    batch.delete(doc.ref);
  });

  await batch.commit();
}

// ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å fetchQuestions() ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡∏π‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
watch(currentClassroomId, async (newId) => {
  if (newId) {
    await fetchQuestions();
  }
});


function closeCreateQuestionModal() {
  console.log("‚úÖ ‡∏õ‡∏¥‡∏î Modal createQuestionModal");

  const modalElement = document.getElementById("createQuestionModal");
  if (modalElement) {
    const modalInstance = bootstrap.Modal.getInstance(modalElement);
    if (modalInstance) {
      modalInstance.hide();
      console.log("‚úÖ Modal ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    } else {
      console.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö instance ‡∏Ç‡∏≠‡∏á Modal");
    }
  } else {
    console.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö element ‡∏Ç‡∏≠‡∏á createQuestionModal");
  }
}

async function signInWithGoogle() {
  const provider = new firebase.auth.GoogleAuthProvider();
  try {
    const result = await auth.signInWithPopup(provider);
    user.value = result.user;
    userName.value = result.user.displayName;
    userPhoto.value = result.user.photoURL;

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Firestore
    const userRef = firestore.collection("users").doc(user.value.uid);
    const userDoc = await userRef.get();

    if (!userDoc.exists) {
      // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Firestore ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      await userRef.set({
        name: user.value.displayName,
        email: user.value.email,
        photo: user.value.photoURL
      });
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
    await fetchClassrooms();
  } catch (error) {
    console.error("Google Sign-in Error:", error);
  }
}

          async function signOut() {
            await auth.signOut();
            user.value = null;
            classrooms.value = [];
            currentClassroomId.value = null;
            currentClassroom.value = null;
          }

          async function updateProfile() {
            if (!user.value) return;
            try {
              await user.value.updateProfile({
                displayName: userName.value,
                photoURL: userPhoto.value
              });
              alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } catch (error) {
              alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå');
            }
          }

            async function showQRCode(classroomId) {
    if (!classroomId || !currentClassroom.value) {
      alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á QR Code ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô!");
      return;
    }

    const qrCodeElement = document.getElementById("qrcode");
    qrCodeElement.innerHTML = "";

    const qrData = JSON.stringify({
      classroomId: classroomId,
      className: currentClassroom.value.info.name, 
      classCode: currentClassroom.value.info.code  
    });


    new QRCode(qrCodeElement, {
      text: qrData,
      width: 200,
      height: 200,
      correctLevel: QRCode.CorrectLevel.H 
    });

    const modal = new bootstrap.Modal(document.getElementById("qrCodeModal"));
    modal.show();
  }


          function downloadQRCode() {
            const canvas = document.querySelector("#qrcode canvas");
            const image = canvas.toDataURL("image/png");
            const link = document.createElement('a');
            link.download = `qrcode-${currentClassroom.value.info.code}.png`;
            link.href = image;
            link.click();
          }

          async function viewClassroom(classroomId) {
            currentClassroomId.value = classroomId;
            const doc = await firestore.collection("users").doc(user.value.uid)
              .collection("classroom").doc(classroomId).get();
            currentClassroom.value = doc.data();
          }


          function backToHome() {
            currentClassroomId.value = null;
            currentClassroom.value = null;
          }

          function editClassroom(classroom) {
            editingClassroom.value = {
              id: classroom.id,
              code: classroom.info.code,
              name: classroom.info.name,
              photo: classroom.info.photo
            };
            editModal.value = new bootstrap.Modal(document.getElementById('editClassroomModal'));
            editModal.value.show();
          }

          async function saveEdit() {
            if (!user.value || !editingClassroom.value.id) return;

            try {
              await firestore.collection("users").doc(user.value.uid)
                .collection("classroom").doc(editingClassroom.value.id)
                .update({
                  info: {
                    code: editingClassroom.value.code,
                    name: editingClassroom.value.name,
                    photo: editingClassroom.value.photo
                  }
                });

              editModal.value.hide();
              await fetchClassrooms();
              alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } catch (error) {
              console.error("Error updating classroom:", error);
              alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');
            }
          }

          function confirmDelete(classroom) {
            deletingClassroom.value = classroom;
            deleteModal.value = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            deleteModal.value.show();
          }

          async function deleteClassroom() {
  if (!user.value || !deletingClassroom.value) return;

  try {
    const classRef = firestore.collection("users").doc(user.value.uid)
      .collection("classroom").doc(deletingClassroom.value.id);

    // üî• ‡∏•‡∏ö Collection "students"
    const studentsRef = classRef.collection("students");
    await deleteCollection(studentsRef);

    // üî• ‡∏•‡∏ö Collection "checkin"
    const checkinRef = classRef.collection("checkin");
    await deleteCollection(checkinRef);

    // üî• ‡∏•‡∏ö Collection "questions"
    const questionsRef = classRef.collection("questions");
    await deleteCollection(questionsRef);

    // üî• ‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏•‡∏±‡∏Å
    await classRef.delete();

    deleteModal.value.hide();
    await fetchClassrooms();
    alert("‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");

  } catch (error) {
    console.error("Error deleting classroom:", error);
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");
  }
}

async function deleteCollection(collectionRef) {
  const snapshot = await collectionRef.get();
  const batch = firestore.batch();

  snapshot.docs.forEach(doc => {
    batch.delete(doc.ref);
  });

  await batch.commit();
}

function viewAnswers(questionId) {
  console.log("üìå ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ID:", questionId);
  
  if (!currentClassroomId.value || !user.value) return;

  selectedQuestionText.value = questions.value.find(q => q.id === questionId)?.question_text || "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°";

  const answersRef = firestore
    .collection("users").doc(user.value.uid)
    .collection("classroom").doc(currentClassroomId.value)
    .collection("questions").doc(questionId)
    .collection("answers");

  answersRef.get()
    .then(snapshot => {
      if (!snapshot.empty) {
        // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ placeholder: true ‡∏≠‡∏≠‡∏Å
        answers.value = snapshot.docs
          .filter(doc => doc.data().placeholder !== true)  // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ placeholder: true
          .map(doc => ({
            id: doc.id,
            std_name: doc.data().std_name,
            text: doc.data().text,
            time: doc.data().time ? formatTimestamp(doc.data().time) : "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏•‡∏≤"
          }));

        const modalElement = document.getElementById("viewAnswersModal");
        const modalInstance = new bootstrap.Modal(modalElement);
        modalInstance.show();
      } else {
        console.log("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ");
        alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ");
      }
    });
}

function formatTimestamp(timestamp) {
  if (!timestamp || !timestamp.toDate) return "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏•‡∏≤";
  
  const date = timestamp.toDate();
  return date.toLocaleString("th-TH", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit"
  });
}

async function saveStudentChanges(student) {
  const studentRef = firestore.collection("users").doc(user.value.uid)
    .collection("classroom").doc(currentClassroomId.value)
    .collection("checkin").doc(student.id) // ‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ student.id ‡πÄ‡∏õ‡πá‡∏ô document ID
    .collection("students").doc(student.id); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ ID ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö document ‡∏ó‡∏µ‡πà Firestore

  try {
    const studentDoc = await studentRef.get();  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (!studentDoc.exists) {
      alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô Firestore");
      return;
    }

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡πá‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
    await studentRef.update({
      std_mark: student.std_mark,
      std_score: student.std_score,
      status: student.status
    });

    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
    student.isEditing = false; // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
  } catch (error) {
    console.error("Error saving student changes:", error);
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á");
  }
}

          onMounted(() => {
            auth.onAuthStateChanged(async (loggedUser) => {
              user.value = loggedUser;
              if (loggedUser) {
                userName.value = loggedUser.displayName || "";
                userPhoto.value = loggedUser.photoURL || "";
                await fetchClassrooms();
              }
              if (currentClassroomId.value) {
              fetchCheckinSessions();
              }
            });
          });

          return {
            editStudent,
            saveStudentChanges,
            showCloseCheckinModal,
            submitCheckin,
            fetchCheckinDetails,
            checkinSessions,
            showCheckinDetailsModal,
            viewCheckinDetails,
            checkinSessions,
            showCheckinDetailsModal,
            answers,
            formatTimestamp,
            viewAnswers,
            questions,
            deleteQuestion,
            fetchQuestions,
            closeCreateQuestionModal,
            saveQuestion,
            openCreateQuestionModal,
            createQuestionModal,
            newQuestionText,
            currentClassroomId,
            user,
            userName,
            userPhoto,
            classrooms,
            showCreateForm,
            showProfile,
            classCode,
            className,
            classPhoto,
            currentClassroomId,
            currentClassroom,
            editingClassroom,
            deletingClassroom,
            signInWithGoogle,
            signOut,
            createClassroom,
            updateProfile,
            showQRCode,
            downloadQRCode,
            viewClassroom,
            backToHome,
            editClassroom,
            saveEdit,
            confirmDelete,
            deleteClassroom,
            currentClassroom,
            students,
            showStudents,
            showStudentList,
            openCheckin,
            closeCheckin,
            saveCheckin,
            removeStudent,
              
          };
        }
      }).mount("#app");
    </script>
</body>
</html>